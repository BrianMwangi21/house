"use strict";
var Sqlite = require('nativescript-sqlite');
var core_1 = require("@angular/core");
var Observable_1 = require("rxjs/Observable");
require("rxjs/add/operator/map");
require("rxjs/add/operator/share");
var state_sql_1 = require("./state.sql");
var state_1 = require("./state");
var db_base_service_1 = require("../db-base.service");
var StateService = (function (_super) {
    __extends(StateService, _super);
    function StateService() {
        var _this = _super.call(this) || this;
        _this._state = [];
        _this._isEmpty = true;
        _this.stateChange$ = new Observable_1.Observable(function (observer) { return _this._stateObserver = observer; }).share();
        _this.subscriptions.push(_this.databaseChange$
            .subscribe(function (database) { return _this.onDatabaseChange(database); }));
        return _this;
    }
    Object.defineProperty(StateService.prototype, "state", {
        get: function () {
            return this._state;
        },
        set: function (value) {
            this._state = value;
            if (this._stateObserver) {
                this._stateObserver.next(value);
            }
        },
        enumerable: true,
        configurable: true
    });
    StateService.prototype.onDatabaseChange = function (database) {
        this.consoleLogMsg('state.service', 'onDatabaseChange');
        this.fetch();
    };
    StateService.prototype.fetch = function () {
        var _this = this;
        this.consoleLogMsg('state.service', 'fetch');
        var data = [];
        if (this.database) {
            this.consoleLogMsg('state.service', state_sql_1.StateSql.selectAll);
            this.database.all(state_sql_1.StateSql.selectAll).then(function (items) {
                if (items && items.length) {
                    items.forEach(function (item, index) {
                        var state = new state_1.State(item.hasOwnProperty('id') ? +(item.id) : 1, item.hasOwnProperty('key') ? item.key : null, item.hasOwnProperty('value') ? item.value : null);
                        _this.consoleLogRecord(index, state);
                        _this._isEmpty = false;
                        data.push(state);
                    });
                }
                else {
                    var state = new state_1.State(0, 'level', '1');
                    data.push(state);
                }
                _this.state = data;
            }, function (error) {
                _this.consoleLogMsg('state.service', 'fetch error: ' + error);
            });
        }
    };
    StateService.prototype.insert = function (state, fetch) {
        var _this = this;
        if (fetch === void 0) { fetch = false; }
        this.consoleLogMsg('state.service', 'insert');
        if (this.database) {
            this.database.execSQL(state_sql_1.StateSql.insert, [state.id, state.key, state.value])
                .then(function (item) {
                _this.consoleLogRecord(0, item);
                if (fetch) {
                    _this.fetch();
                }
            });
        }
    };
    StateService.prototype.updateLevel = function (level) {
        var _this = this;
        this.consoleLogMsg('state.service', 'updateLevel');
        if (this.database) {
            if (this._isEmpty) {
                this.insert(new state_1.State(0, 'level', String(level)));
            }
            else {
                this.database.execSQL(state_sql_1.StateSql.updateLevel, [level])
                    .then(function (item) {
                    _this.consoleLogRecord(0, item);
                    _this.fetch();
                });
            }
        }
    };
    StateService.prototype.truncate = function () {
        var _this = this;
        this.consoleLogMsg('state.service', 'truncate');
        if (this.database) {
            this.database.execSQL(state_sql_1.StateSql.dropTable)
                .then(function (err) {
                if (err) {
                    _this.consoleLogMsg('state.service', 'ERROR: Attempt to drop the config table failed.');
                    return;
                }
                _this.database.execSQL(state_sql_1.StateSql.createTable)
                    .then(function (err) {
                    if (err) {
                        _this.consoleLogMsg('state.service', 'ERROR: Attempt to create the config table failed.');
                        return;
                    }
                    _this.insert(new state_1.State(0, 'level', '1'), true);
                });
            });
        }
    };
    StateService.prototype.getKeyValue = function (key) {
        this.consoleLogMsg('state.service', 'getKeyValue');
        var arr;
        if (this.state) {
            arr = this.state.filter(function (item) {
                return item.key.toLowerCase() === key.toLowerCase();
            });
            if (arr && arr.length) {
                return arr[0]['value'];
            }
        }
        return null;
    };
    return StateService;
}(db_base_service_1.DbBaseService));
StateService = __decorate([
    core_1.Injectable(),
    __metadata("design:paramtypes", [])
], StateService);
exports.StateService = StateService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInN0YXRlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLElBQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0FBRzlDLHNDQUF5QztBQUN6Qyw4Q0FBMkM7QUFHM0MsaUNBQStCO0FBQy9CLG1DQUFpQztBQUVqQyx5Q0FBcUM7QUFDckMsaUNBQThCO0FBQzlCLHNEQUFpRDtBQUlqRCxJQUFhLFlBQVk7SUFBUyxnQ0FBYTtJQW1CN0M7UUFBQSxZQUNFLGlCQUFPLFNBY1I7UUFaQyxLQUFJLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUNqQixLQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztRQUVyQixLQUFJLENBQUMsWUFBWSxHQUFHLElBQUksdUJBQVUsQ0FDaEMsVUFBQyxRQUFhLElBQUssT0FBQSxLQUFJLENBQUMsY0FBYyxHQUFHLFFBQVEsRUFBOUIsQ0FBOEIsQ0FDbEQsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUVWLEtBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLEtBQUksQ0FBQyxlQUFlO2FBQ3pDLFNBQVMsQ0FDUixVQUFDLFFBQWEsSUFBSyxPQUFBLEtBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsRUFBL0IsQ0FBK0IsQ0FDbkQsQ0FBQyxDQUFDOztJQUVQLENBQUM7SUExQkQsc0JBQUksK0JBQUs7YUFBVDtZQUNFLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO1FBQ3JCLENBQUM7YUFFRCxVQUFVLEtBQWM7WUFDdEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUM7WUFDcEIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3hCLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2xDLENBQUM7UUFDSCxDQUFD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O0FBN0lZLG9DQUFZIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgU3FsaXRlID0gcmVxdWlyZSgnbmF0aXZlc2NyaXB0LXNxbGl0ZScpO1xuXG5cbmltcG9ydCB7SW5qZWN0YWJsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge09ic2VydmFibGV9IGZyb20gJ3J4anMvT2JzZXJ2YWJsZSc7XG5pbXBvcnQge09ic2VydmVyfSAgIGZyb20gJ3J4anMvT2JzZXJ2ZXInO1xuXG5pbXBvcnQgJ3J4anMvYWRkL29wZXJhdG9yL21hcCc7XG5pbXBvcnQgJ3J4anMvYWRkL29wZXJhdG9yL3NoYXJlJztcblxuaW1wb3J0IHtTdGF0ZVNxbH0gZnJvbSAnLi9zdGF0ZS5zcWwnO1xuaW1wb3J0IHtTdGF0ZX0gZnJvbSAnLi9zdGF0ZSc7XG5pbXBvcnQge0RiQmFzZVNlcnZpY2V9IGZyb20gJy4uL2RiLWJhc2Uuc2VydmljZSc7XG5pbXBvcnQge1NoYXJlZFV0aWxzfSBmcm9tICcuLi9zaGFyZWQtdXRpbHMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgU3RhdGVTZXJ2aWNlIGV4dGVuZHMgRGJCYXNlU2VydmljZSB7XG5cbiAgc3RhdGVDaGFuZ2UkOiBPYnNlcnZhYmxlPFN0YXRlW10+O1xuXG4gIHByaXZhdGUgX3N0YXRlOiBTdGF0ZVtdO1xuICBwcml2YXRlIF9zdGF0ZU9ic2VydmVyOiBPYnNlcnZlcjxTdGF0ZVtdPjtcbiAgcHJpdmF0ZSBfaXNFbXB0eTogQm9vbGVhbjtcblxuICBnZXQgc3RhdGUoKTogU3RhdGVbXSB7XG4gICAgcmV0dXJuIHRoaXMuX3N0YXRlO1xuICB9XG5cbiAgc2V0IHN0YXRlKHZhbHVlOiBTdGF0ZVtdKSB7XG4gICAgdGhpcy5fc3RhdGUgPSB2YWx1ZTtcbiAgICBpZiAodGhpcy5fc3RhdGVPYnNlcnZlcikge1xuICAgICAgdGhpcy5fc3RhdGVPYnNlcnZlci5uZXh0KHZhbHVlKTtcbiAgICB9XG4gIH1cblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpO1xuXG4gICAgdGhpcy5fc3RhdGUgPSBbXTtcbiAgICB0aGlzLl9pc0VtcHR5ID0gdHJ1ZTtcblxuICAgIHRoaXMuc3RhdGVDaGFuZ2UkID0gbmV3IE9ic2VydmFibGU8U3RhdGVbXT4oXG4gICAgICAob2JzZXJ2ZXI6IGFueSkgPT4gdGhpcy5fc3RhdGVPYnNlcnZlciA9IG9ic2VydmVyXG4gICAgKS5zaGFyZSgpO1xuXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLnB1c2godGhpcy5kYXRhYmFzZUNoYW5nZSRcbiAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgIChkYXRhYmFzZTogYW55KSA9PiB0aGlzLm9uRGF0YWJhc2VDaGFuZ2UoZGF0YWJhc2UpXG4gICAgICApKTtcblxuICB9XG5cbiAgb25EYXRhYmFzZUNoYW5nZShkYXRhYmFzZTogYW55KSB7XG4gICAgdGhpcy5jb25zb2xlTG9nTXNnKCdzdGF0ZS5zZXJ2aWNlJywgJ29uRGF0YWJhc2VDaGFuZ2UnKTtcbiAgICB0aGlzLmZldGNoKCk7XG4gIH1cblxuICBmZXRjaCgpIHtcbiAgICB0aGlzLmNvbnNvbGVMb2dNc2coJ3N0YXRlLnNlcnZpY2UnLCAnZmV0Y2gnKTtcbiAgICBsZXQgZGF0YTogU3RhdGVbXSA9IFtdO1xuXG4gICAgaWYgKHRoaXMuZGF0YWJhc2UpIHtcbiAgICAgIHRoaXMuY29uc29sZUxvZ01zZygnc3RhdGUuc2VydmljZScsIFN0YXRlU3FsLnNlbGVjdEFsbCk7XG4gICAgICB0aGlzLmRhdGFiYXNlLmFsbChTdGF0ZVNxbC5zZWxlY3RBbGwpLnRoZW4oKGl0ZW1zOiBhbnlbXSkgPT4ge1xuICAgICAgICBpZiAoaXRlbXMgJiYgaXRlbXMubGVuZ3RoKSB7XG4gICAgICAgICAgaXRlbXMuZm9yRWFjaCgoaXRlbTogYW55LCBpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgICBsZXQgc3RhdGU6IFN0YXRlID0gbmV3IFN0YXRlKFxuICAgICAgICAgICAgICBpdGVtLmhhc093blByb3BlcnR5KCdpZCcpID8gKyhpdGVtLmlkKSA6IDEsXG4gICAgICAgICAgICAgIGl0ZW0uaGFzT3duUHJvcGVydHkoJ2tleScpID8gaXRlbS5rZXkgOiBudWxsLFxuICAgICAgICAgICAgICBpdGVtLmhhc093blByb3BlcnR5KCd2YWx1ZScpID8gaXRlbS52YWx1ZSA6IG51bGxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICB0aGlzLmNvbnNvbGVMb2dSZWNvcmQoaW5kZXgsIHN0YXRlKTtcbiAgICAgICAgICAgIHRoaXMuX2lzRW1wdHkgPSBmYWxzZTtcbiAgICAgICAgICAgIGRhdGEucHVzaChzdGF0ZSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbGV0IHN0YXRlID0gbmV3IFN0YXRlKFxuICAgICAgICAgICAgMCxcbiAgICAgICAgICAgICdsZXZlbCcsXG4gICAgICAgICAgICAnMSdcbiAgICAgICAgICApO1xuICAgICAgICAgIGRhdGEucHVzaChzdGF0ZSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zdGF0ZSA9IGRhdGE7XG4gICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgIHRoaXMuY29uc29sZUxvZ01zZygnc3RhdGUuc2VydmljZScsICdmZXRjaCBlcnJvcjogJyArIGVycm9yKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGluc2VydChzdGF0ZTogU3RhdGUsIGZldGNoOiBCb29sZWFuID0gZmFsc2UpIHtcbiAgICB0aGlzLmNvbnNvbGVMb2dNc2coJ3N0YXRlLnNlcnZpY2UnLCAnaW5zZXJ0Jyk7XG4gICAgaWYgKHRoaXMuZGF0YWJhc2UpIHtcbiAgICAgIHRoaXMuZGF0YWJhc2UuZXhlY1NRTChTdGF0ZVNxbC5pbnNlcnQsIFtzdGF0ZS5pZCwgc3RhdGUua2V5LCBzdGF0ZS52YWx1ZV0pXG4gICAgICAgIC50aGVuKChpdGVtOiBhbnkpID0+IHtcbiAgICAgICAgICB0aGlzLmNvbnNvbGVMb2dSZWNvcmQoMCwgaXRlbSk7XG4gICAgICAgICAgaWYgKGZldGNoKSB7XG4gICAgICAgICAgICB0aGlzLmZldGNoKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gIH1cblxuICB1cGRhdGVMZXZlbChsZXZlbDogbnVtYmVyKSB7XG4gICAgdGhpcy5jb25zb2xlTG9nTXNnKCdzdGF0ZS5zZXJ2aWNlJywgJ3VwZGF0ZUxldmVsJyk7XG4gICAgaWYgKHRoaXMuZGF0YWJhc2UpIHtcbiAgICAgIGlmICh0aGlzLl9pc0VtcHR5KSB7XG4gICAgICAgIHRoaXMuaW5zZXJ0KG5ldyBTdGF0ZSgwLCAnbGV2ZWwnLCBTdHJpbmcobGV2ZWwpKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmRhdGFiYXNlLmV4ZWNTUUwoU3RhdGVTcWwudXBkYXRlTGV2ZWwsIFtsZXZlbF0pXG4gICAgICAgICAgLnRoZW4oKGl0ZW06IGFueSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5jb25zb2xlTG9nUmVjb3JkKDAsIGl0ZW0pO1xuICAgICAgICAgICAgdGhpcy5mZXRjaCgpO1xuICAgICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHRydW5jYXRlKCk6IHZvaWQge1xuICAgIHRoaXMuY29uc29sZUxvZ01zZygnc3RhdGUuc2VydmljZScsICd0cnVuY2F0ZScpO1xuICAgIGlmICh0aGlzLmRhdGFiYXNlKSB7XG4gICAgICB0aGlzLmRhdGFiYXNlLmV4ZWNTUUwoU3RhdGVTcWwuZHJvcFRhYmxlKVxuICAgICAgICAudGhlbigoZXJyOiBhbnkpID0+IHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICB0aGlzLmNvbnNvbGVMb2dNc2coJ3N0YXRlLnNlcnZpY2UnLCAnRVJST1I6IEF0dGVtcHQgdG8gZHJvcCB0aGUgY29uZmlnIHRhYmxlIGZhaWxlZC4nKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5kYXRhYmFzZS5leGVjU1FMKFN0YXRlU3FsLmNyZWF0ZVRhYmxlKVxuICAgICAgICAgICAgLnRoZW4oKGVycjogYW55KSA9PiB7XG4gICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnNvbGVMb2dNc2coJ3N0YXRlLnNlcnZpY2UnLCAnRVJST1I6IEF0dGVtcHQgdG8gY3JlYXRlIHRoZSBjb25maWcgdGFibGUgZmFpbGVkLicpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB0aGlzLmluc2VydChuZXcgU3RhdGUoXG4gICAgICAgICAgICAgICAgMCxcbiAgICAgICAgICAgICAgICAnbGV2ZWwnLFxuICAgICAgICAgICAgICAgICcxJ1xuICAgICAgICAgICAgICApLCB0cnVlKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBnZXRLZXlWYWx1ZShrZXk6IHN0cmluZyk6IGFueSB7XG4gICAgdGhpcy5jb25zb2xlTG9nTXNnKCdzdGF0ZS5zZXJ2aWNlJywgJ2dldEtleVZhbHVlJyk7XG4gICAgbGV0IGFycjogYW55W107XG4gICAgaWYgKHRoaXMuc3RhdGUpIHtcbiAgICAgIGFyciA9IHRoaXMuc3RhdGUuZmlsdGVyKChpdGVtOiBTdGF0ZSkgPT4ge1xuICAgICAgICByZXR1cm4gaXRlbS5rZXkudG9Mb3dlckNhc2UoKSA9PT0ga2V5LnRvTG93ZXJDYXNlKCk7XG4gICAgICB9KTtcbiAgICAgIGlmIChhcnIgJiYgYXJyLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gYXJyWzBdWyd2YWx1ZSddO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG59XG4iXX0=