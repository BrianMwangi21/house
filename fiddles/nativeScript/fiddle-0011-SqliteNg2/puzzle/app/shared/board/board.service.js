"use strict";
var core_1 = require("@angular/core");
var Observable_1 = require("rxjs/Observable");
require("rxjs/add/operator/map");
require("rxjs/add/operator/share");
var config_1 = require("../config");
var board_1 = require("./board");
var square_1 = require("./square");
var shared_utils_1 = require("../shared-utils");
var BoardService = (function () {
    function BoardService() {
        var _this = this;
        this.gameBoardChange$ = new Observable_1.Observable(function (observer) { return _this._gameBoardObserver = observer; }).share();
    }
    Object.defineProperty(BoardService.prototype, "gameBoard", {
        get: function () {
            return this._gameBoard;
        },
        set: function (board) {
            if (this._gameBoard !== board) {
                this._gameBoard = board;
                if (this._gameBoardObserver) {
                    this._gameBoardObserver.next(board);
                }
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BoardService.prototype, "emptySquare", {
        get: function () {
            if (this._gameBoard && this._gameBoard.squares.length) {
                var matches = this._gameBoard.squares.filter(function (square) {
                    return square.cssClass === 'empty';
                });
                if (matches && matches.length) {
                    return matches[0];
                }
            }
            return null;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BoardService.prototype, "startingSequence", {
        get: function () {
            return this._startingSequence;
        },
        set: function (sequence) {
            if (this._startingSequence !== sequence) {
                this._startingSequence = sequence;
            }
        },
        enumerable: true,
        configurable: true
    });
    BoardService.prototype.initBoard = function (cols, rows, title, level, moves, nextScreen) {
        try {
            var board = new board_1.Board(title, moves, level, nextScreen), range = cols * rows, lastRow = rows - 1, lastCol = cols - 1, col = 0, row = 0, squareCount = range - 1, buttonId = null, buttonCls = null, i = 0, expectedValue = 0, value = 0, square = null;
            this.startingSequence = shared_utils_1.SharedUtils.generateGameSequence(1, squareCount, squareCount);
            for (; row < rows; row++) {
                for (; col < cols; col++) {
                    buttonId = 'b' + (i + 1);
                    buttonCls = buttonId + 'Cls';
                    expectedValue = i + 1;
                    value = this.startingSequence[i];
                    square = new square_1.Square(buttonId, row, col, "" + value, "" + expectedValue, i < squareCount ? value === expectedValue ? 'square correct' : 'square incorrect' : buttonCls);
                    if (i < squareCount) {
                        this.printSquare(i, square);
                        board.squares.push(square);
                        i++;
                    }
                }
                col = 0;
            }
            buttonId = 'b' + range;
            buttonCls = 'empty';
            square = new square_1.Square(buttonId, lastRow, lastCol, '  ', '  ', buttonCls);
            this.printSquare(i++, square);
            board.squares.push(square);
            this.gameBoard = board;
        }
        catch (err) {
            this.handleErrors(err);
        }
    };
    BoardService.prototype.isValidMove = function (squareA, squareB) {
        var rowDelta = Math.abs(squareA.row - squareB.row), colDelta = Math.abs(squareA.col - squareB.col), rc = false;
        this.printSquare(0, squareA);
        this.printSquare(1, squareB);
        if (squareA.row == squareB.row || squareA.col == squareB.col) {
            rc = (rowDelta == 0 || rowDelta == 1) && (colDelta == 0 || colDelta == 1);
        }
        return rc;
    };
    BoardService.prototype.isEmpty = function (square) {
        return square.cssClass === 'empty' ? true : false;
    };
    BoardService.prototype.moveSquare = function (squareA, squareB) {
        var newMoves = this._gameBoard.moves + 1, newGameBoard = new board_1.Board(this._gameBoard.title, newMoves, this._gameBoard.level, this._gameBoard.nextScreen);
        this._gameBoard.squares.map(function (square) {
            if (square.row === squareA.row && square.col === squareA.col) {
                var newSquareA = new square_1.Square(squareA.id, squareA.row, squareA.col, squareB.value, squareA.expectedValue, squareB.cssClass);
                if (newSquareA.cssClass !== 'empty') {
                    if (newSquareA.value === newSquareA.expectedValue) {
                        newSquareA.cssClass = 'square correct';
                    }
                    else {
                        newSquareA.cssClass = 'square incorrect';
                    }
                }
                newGameBoard.squares.push(newSquareA);
            }
            else if (square.row === squareB.row && square.col === squareB.col) {
                var newSquareB = new square_1.Square(squareB.id, squareB.row, squareB.col, squareA.value, squareB.expectedValue, squareA.cssClass);
                if (newSquareB.cssClass !== 'empty') {
                    if (newSquareB.value === newSquareB.expectedValue) {
                        newSquareB.cssClass = 'square correct';
                    }
                    else {
                        newSquareB.cssClass = 'square incorrect';
                    }
                }
                newGameBoard.squares.push(newSquareB);
            }
            else {
                var newSquare = new square_1.Square(square.id, square.row, square.col, square.value, square.expectedValue, square.cssClass);
                newGameBoard.squares.push(newSquare);
            }
        });
        this.gameBoard = newGameBoard;
    };
    BoardService.prototype.isGameOver = function () {
        var moves = this._gameBoard.squares.filter(function (square) {
            return square.value === square.expectedValue;
        });
        return moves && moves.length === this._gameBoard.squares.length ? true : false;
    };
    BoardService.prototype.handleErrors = function (error) {
        if (config_1.Config.isDev) {
            console.log(error);
        }
        return Observable_1.Observable.throw(error);
    };
    BoardService.prototype.printSquare = function (i, square) {
        if (config_1.Config.isDev) {
            console.log('Square' + (i + 1) + ' = { id: ' + square.id + ', row: ' + square.row + ', col: ' + square.col + ', value: ' + square.value + ', ' + square.expectedValue + ', class: ' + square.cssClass + ' }');
        }
    };
    return BoardService;
}());
BoardService = __decorate([
    core_1.Injectable(),
    __metadata("design:paramtypes", [])
], BoardService);
exports.BoardService = BoardService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9hcmQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImJvYXJkLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLHNDQUFxRDtBQUNyRCw4Q0FBeUQ7QUFHekQsaUNBQStCO0FBQy9CLG1DQUFpQztBQUVqQyxvQ0FBbUQ7QUFDbkQsaUNBQWlEO0FBQ2pELG1DQUFrRDtBQUNsRCxnREFBeUQ7QUFHekQsSUFBYSxZQUFZO0lBNEN2QjtRQUFBLGlCQUlDO1FBSEMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksdUJBQVUsQ0FDcEMsVUFBQyxRQUFhLElBQUssT0FBQSxLQUFJLENBQUMsa0JBQWtCLEdBQUcsUUFBUSxFQUFsQyxDQUFrQyxDQUN0RCxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ1osQ0FBQztJQXpDRCxzQkFBSSxtQ0FBUzthQVNiO1lBQ0UsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7UUFDekIsQ0FBQzthQVhELFVBQWMsS0FBWTtZQUN4QixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxLQUFLLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQzlCLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO2dCQUN4QixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDO29CQUM1QixJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUN0QyxDQUFDO1lBQ0gsQ0FBQztRQUNILENBQUM7OztPQUFBO0lBTUQsc0JBQUkscUNBQVc7YUFBZjtZQUNFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztnQkFDdEQsSUFBSSxPQUFPLEdBQWEsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFVBQVUsTUFBYztv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S0FBSyxHQUFHLElBQUksR0FBRyxNQUFNLENBQUMsYUFBYSxHQUFHLFdBQVcsR0FBRyxNQUFNLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQ2hOLENBQUM7SUFDSCxDQUFDO0lBQ0gsbUJBQUM7QUFBRCxDQUFDLEFBdk1ELElBdU1DO0FBdk1ZLFlBQVk7SUFEeEIsaUJBQVUsRUFBRTs7R0FDQSxZQUFZLENBdU14QjtBQXZNWSxvQ0FBWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SW5qZWN0YWJsZX0gICAgICAgICAgICAgZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge09ic2VydmFibGV9ICAgICAgICAgICAgICAgZnJvbSAncnhqcy9PYnNlcnZhYmxlJztcbmltcG9ydCB7T2JzZXJ2ZXJ9ICAgICAgICAgICAgICAgICBmcm9tICdyeGpzL09ic2VydmVyJztcblxuaW1wb3J0ICdyeGpzL2FkZC9vcGVyYXRvci9tYXAnO1xuaW1wb3J0ICdyeGpzL2FkZC9vcGVyYXRvci9zaGFyZSc7XG5cbmltcG9ydCB7Q29uZmlnfSAgICAgICAgICAgICAgICAgICBmcm9tIFwiLi4vY29uZmlnXCI7XG5pbXBvcnQge0JvYXJkfSAgICAgICAgICAgICAgICAgICAgZnJvbSBcIi4vYm9hcmRcIjtcbmltcG9ydCB7U3F1YXJlfSAgICAgICAgICAgICAgICAgICBmcm9tIFwiLi9zcXVhcmVcIjtcbmltcG9ydCB7U2hhcmVkVXRpbHN9ICAgICAgICAgICAgICBmcm9tIFwiLi4vc2hhcmVkLXV0aWxzXCI7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBCb2FyZFNlcnZpY2Uge1xuXG4gIGdhbWVCb2FyZENoYW5nZSQ6IE9ic2VydmFibGU8Qm9hcmQ+O1xuXG4gIHByaXZhdGUgX2dhbWVCb2FyZDogQm9hcmQ7XG4gIHByaXZhdGUgX2dhbWVCb2FyZE9ic2VydmVyOiBPYnNlcnZlcjxCb2FyZD47XG5cbiAgc2V0IGdhbWVCb2FyZChib2FyZDogQm9hcmQpIHtcbiAgICBpZiAodGhpcy5fZ2FtZUJvYXJkICE9PSBib2FyZCkge1xuICAgICAgdGhpcy5fZ2FtZUJvYXJkID0gYm9hcmQ7XG4gICAgICBpZiAodGhpcy5fZ2FtZUJvYXJkT2JzZXJ2ZXIpIHtcbiAgICAgICAgdGhpcy5fZ2FtZUJvYXJkT2JzZXJ2ZXIubmV4dChib2FyZCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZ2V0IGdhbWVCb2FyZCgpOiBCb2FyZCB7XG4gICAgcmV0dXJuIHRoaXMuX2dhbWVCb2FyZDtcbiAgfVxuXG4gIGdldCBlbXB0eVNxdWFyZSgpOiBTcXVhcmUge1xuICAgIGlmICh0aGlzLl9nYW1lQm9hcmQgJiYgdGhpcy5fZ2FtZUJvYXJkLnNxdWFyZXMubGVuZ3RoKSB7XG4gICAgICBsZXQgbWF0Y2hlczogU3F1YXJlW10gPSB0aGlzLl9nYW1lQm9hcmQuc3F1YXJlcy5maWx0ZXIoZnVuY3Rpb24gKHNxdWFyZTogU3F1YXJlKSB7XG4gICAgICAgIHJldHVybiBzcXVhcmUuY3NzQ2xhc3MgPT09ICdlbXB0eSc7XG4gICAgICB9KTtcbiAgICAgIGlmIChtYXRjaGVzICYmIG1hdGNoZXMubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiBtYXRjaGVzWzBdO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHByaXZhdGUgX3N0YXJ0aW5nU2VxdWVuY2U6IG51bWJlcltdO1xuXG4gIHNldCBzdGFydGluZ1NlcXVlbmNlKHNlcXVlbmNlOiBudW1iZXJbXSkge1xuICAgIGlmICh0aGlzLl9zdGFydGluZ1NlcXVlbmNlICE9PSBzZXF1ZW5jZSkge1xuICAgICAgdGhpcy5fc3RhcnRpbmdTZXF1ZW5jZSA9IHNlcXVlbmNlO1xuICAgIH1cbiAgfVxuXG4gIGdldCBzdGFydGluZ1NlcXVlbmNlKCk6IG51bWJlcltdIHtcbiAgICByZXR1cm4gdGhpcy5fc3RhcnRpbmdTZXF1ZW5jZTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuZ2FtZUJvYXJkQ2hhbmdlJCA9IG5ldyBPYnNlcnZhYmxlPEJvYXJkPihcbiAgICAgIChvYnNlcnZlcjogYW55KSA9PiB0aGlzLl9nYW1lQm9hcmRPYnNlcnZlciA9IG9ic2VydmVyXG4gICAgKS5zaGFyZSgpO1xuICB9XG5cbiAgaW5pdEJvYXJkKGNvbHM6IG51bWJlciwgcm93czogbnVtYmVyLCB0aXRsZTogc3RyaW5nLCBsZXZlbDogbnVtYmVyLCBtb3ZlczogbnVtYmVyLCBuZXh0U2NyZWVuOiBzdHJpbmcpIHtcbiAgICB0cnkge1xuICAgICAgbGV0IGJvYXJkID0gbmV3IEJvYXJkKHRpdGxlLCBtb3ZlcywgbGV2ZWwsIG5leHRTY3JlZW4pLFxuICAgICAgICByYW5nZTogbnVtYmVyID0gY29scyAqIHJvd3MsXG4gICAgICAgIGxhc3RSb3c6IG51bWJlciA9IHJvd3MgLSAxLFxuICAgICAgICBsYXN0Q29sOiBudW1iZXIgPSBjb2xzIC0gMSxcbiAgICAgICAgY29sOiBudW1iZXIgPSAwLFxuICAgICAgICByb3c6IG51bWJlciA9IDAsXG4gICAgICAgIHNxdWFyZUNvdW50OiBudW1iZXIgPSByYW5nZSAtIDEsXG4gICAgICAgIGJ1dHRvbklkOiBzdHJpbmcgPSBudWxsLFxuICAgICAgICBidXR0b25DbHM6IHN0cmluZyA9IG51bGwsXG4gICAgICAgIGk6IG51bWJlciA9IDAsXG4gICAgICAgIGV4cGVjdGVkVmFsdWU6IG51bWJlciA9IDAsXG4gICAgICAgIHZhbHVlOiBudW1iZXIgPSAwLFxuICAgICAgICBzcXVhcmU6IFNxdWFyZSA9IG51bGw7XG5cbiAgICAgIHRoaXMuc3RhcnRpbmdTZXF1ZW5jZSA9IFNoYXJlZFV0aWxzLmdlbmVyYXRlR2FtZVNlcXVlbmNlKDEsIHNxdWFyZUNvdW50LCBzcXVhcmVDb3VudCk7XG5cbiAgICAgIGZvciAoOyByb3cgPCByb3dzOyByb3crKykge1xuICAgICAgICBmb3IgKDsgY29sIDwgY29sczsgY29sKyspIHtcbiAgICAgICAgICBidXR0b25JZCA9ICdiJyArIChpICsgMSk7XG4gICAgICAgICAgYnV0dG9uQ2xzID0gYnV0dG9uSWQgKyAnQ2xzJztcbiAgICAgICAgICBleHBlY3RlZFZhbHVlID0gaSArIDE7XG4gICAgICAgICAgdmFsdWUgPSB0aGlzLnN0YXJ0aW5nU2VxdWVuY2VbaV07XG4gICAgICAgICAgc3F1YXJlID0gbmV3IFNxdWFyZShidXR0b25JZCxcbiAgICAgICAgICAgIHJvdyxcbiAgICAgICAgICAgIGNvbCxcbiAgICAgICAgICAgIFwiXCIgKyB2YWx1ZSxcbiAgICAgICAgICAgIFwiXCIgKyBleHBlY3RlZFZhbHVlLFxuICAgICAgICAgICAgaSA8IHNxdWFyZUNvdW50ID8gdmFsdWUgPT09IGV4cGVjdGVkVmFsdWUgPyAnc3F1YXJlIGNvcnJlY3QnIDogJ3NxdWFyZSBpbmNvcnJlY3QnIDogYnV0dG9uQ2xzKTtcblxuICAgICAgICAgIGlmIChpIDwgc3F1YXJlQ291bnQpIHtcbiAgICAgICAgICAgIHRoaXMucHJpbnRTcXVhcmUoaSwgc3F1YXJlKTtcbiAgICAgICAgICAgIGJvYXJkLnNxdWFyZXMucHVzaChzcXVhcmUpO1xuICAgICAgICAgICAgaSsrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjb2wgPSAwO1xuICAgICAgfVxuXG4gICAgICBidXR0b25JZCA9ICdiJyArIHJhbmdlO1xuICAgICAgYnV0dG9uQ2xzID0gJ2VtcHR5JztcbiAgICAgIHNxdWFyZSA9IG5ldyBTcXVhcmUoYnV0dG9uSWQsIGxhc3RSb3csIGxhc3RDb2wsICcgICcsICcgICcsIGJ1dHRvbkNscyk7XG5cbiAgICAgIHRoaXMucHJpbnRTcXVhcmUoaSsrLCBzcXVhcmUpO1xuICAgICAgYm9hcmQuc3F1YXJlcy5wdXNoKHNxdWFyZSk7XG4gICAgICB0aGlzLmdhbWVCb2FyZCA9IGJvYXJkO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhpcy5oYW5kbGVFcnJvcnMoZXJyKTtcbiAgICB9XG4gIH1cblxuICBpc1ZhbGlkTW92ZShzcXVhcmVBOiBTcXVhcmUsIHNxdWFyZUI6IFNxdWFyZSk6IGJvb2xlYW4ge1xuICAgIGxldCByb3dEZWx0YTogbnVtYmVyID0gTWF0aC5hYnMoc3F1YXJlQS5yb3cgLSBzcXVhcmVCLnJvdyksXG4gICAgICBjb2xEZWx0YTogbnVtYmVyID0gTWF0aC5hYnMoc3F1YXJlQS5jb2wgLSBzcXVhcmVCLmNvbCksXG4gICAgICByYzogYm9vbGVhbiA9IGZhbHNlO1xuICAgIHRoaXMucHJpbnRTcXVhcmUoMCwgc3F1YXJlQSk7XG4gICAgdGhpcy5wcmludFNxdWFyZSgxLCBzcXVhcmVCKTtcbiAgICBpZiAoc3F1YXJlQS5yb3cgPT0gc3F1YXJlQi5yb3cgfHwgc3F1YXJlQS5jb2wgPT0gc3F1YXJlQi5jb2wpIHtcbiAgICAgIHJjID0gKHJvd0RlbHRhID09IDAgfHwgcm93RGVsdGEgPT0gMSkgJiYgKGNvbERlbHRhID09IDAgfHwgY29sRGVsdGEgPT0gMSk7XG4gICAgfVxuICAgIHJldHVybiByYztcbiAgfVxuXG4gIGlzRW1wdHkoc3F1YXJlOiBTcXVhcmUpOiBib29sZWFuIHtcbiAgICByZXR1cm4gc3F1YXJlLmNzc0NsYXNzID09PSAnZW1wdHknID8gdHJ1ZSA6IGZhbHNlO1xuICB9XG5cbiAgbW92ZVNxdWFyZShzcXVhcmVBOiBTcXVhcmUsIHNxdWFyZUI6IFNxdWFyZSkge1xuXG4gICAgbGV0IG5ld01vdmVzOm51bWJlciA9IHRoaXMuX2dhbWVCb2FyZC5tb3ZlcysxLFxuICAgICAgbmV3R2FtZUJvYXJkOiBCb2FyZCA9IG5ldyBCb2FyZCh0aGlzLl9nYW1lQm9hcmQudGl0bGUsXG4gICAgICBuZXdNb3ZlcyxcbiAgICAgIHRoaXMuX2dhbWVCb2FyZC5sZXZlbCxcbiAgICAgIHRoaXMuX2dhbWVCb2FyZC5uZXh0U2NyZWVuKTtcblxuICAgIHRoaXMuX2dhbWVCb2FyZC5zcXVhcmVzLm1hcChmdW5jdGlvbiAoc3F1YXJlOiBTcXVhcmUpIHtcbiAgICAgIGlmIChzcXVhcmUucm93ID09PSBzcXVhcmVBLnJvdyAmJiBzcXVhcmUuY29sID09PSBzcXVhcmVBLmNvbCkge1xuICAgICAgICBsZXQgbmV3U3F1YXJlQTogU3F1YXJlID0gbmV3IFNxdWFyZShcbiAgICAgICAgICBzcXVhcmVBLmlkLFxuICAgICAgICAgIHNxdWFyZUEucm93LFxuICAgICAgICAgIHNxdWFyZUEuY29sLFxuICAgICAgICAgIHNxdWFyZUIudmFsdWUsXG4gICAgICAgICAgc3F1YXJlQS5leHBlY3RlZFZhbHVlLFxuICAgICAgICAgIHNxdWFyZUIuY3NzQ2xhc3NcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAobmV3U3F1YXJlQS5jc3NDbGFzcyAhPT0gJ2VtcHR5Jykge1xuICAgICAgICAgIGlmIChuZXdTcXVhcmVBLnZhbHVlID09PSBuZXdTcXVhcmVBLmV4cGVjdGVkVmFsdWUpIHtcbiAgICAgICAgICAgIG5ld1NxdWFyZUEuY3NzQ2xhc3MgPSAnc3F1YXJlIGNvcnJlY3QnO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBuZXdTcXVhcmVBLmNzc0NsYXNzID0gJ3NxdWFyZSBpbmNvcnJlY3QnO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBuZXdHYW1lQm9hcmQuc3F1YXJlcy5wdXNoKG5ld1NxdWFyZUEpO1xuXG4gICAgICB9IGVsc2UgaWYgKHNxdWFyZS5yb3cgPT09IHNxdWFyZUIucm93ICYmIHNxdWFyZS5jb2wgPT09IHNxdWFyZUIuY29sKSB7XG4gICAgICAgIGxldCBuZXdTcXVhcmVCOiBTcXVhcmUgPSBuZXcgU3F1YXJlKFxuICAgICAgICAgIHNxdWFyZUIuaWQsXG4gICAgICAgICAgc3F1YXJlQi5yb3csXG4gICAgICAgICAgc3F1YXJlQi5jb2wsXG4gICAgICAgICAgc3F1YXJlQS52YWx1ZSxcbiAgICAgICAgICBzcXVhcmVCLmV4cGVjdGVkVmFsdWUsXG4gICAgICAgICAgc3F1YXJlQS5jc3NDbGFzc1xuICAgICAgICApO1xuXG4gICAgICAgIGlmIChuZXdTcXVhcmVCLmNzc0NsYXNzICE9PSAnZW1wdHknKSB7XG4gICAgICAgICAgaWYgKG5ld1NxdWFyZUIudmFsdWUgPT09IG5ld1NxdWFyZUIuZXhwZWN0ZWRWYWx1ZSkge1xuICAgICAgICAgICAgbmV3U3F1YXJlQi5jc3NDbGFzcyA9ICdzcXVhcmUgY29ycmVjdCc7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG5ld1NxdWFyZUIuY3NzQ2xhc3MgPSAnc3F1YXJlIGluY29ycmVjdCc7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgbmV3R2FtZUJvYXJkLnNxdWFyZXMucHVzaChuZXdTcXVhcmVCKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxldCBuZXdTcXVhcmU6IFNxdWFyZSA9IG5ldyBTcXVhcmUoXG4gICAgICAgICAgc3F1YXJlLmlkLFxuICAgICAgICAgIHNxdWFyZS5yb3csXG4gICAgICAgICAgc3F1YXJlLmNvbCxcbiAgICAgICAgICBzcXVhcmUudmFsdWUsXG4gICAgICAgICAgc3F1YXJlLmV4cGVjdGVkVmFsdWUsXG4gICAgICAgICAgc3F1YXJlLmNzc0NsYXNzXG4gICAgICAgIClcbiAgICAgICAgbmV3R2FtZUJvYXJkLnNxdWFyZXMucHVzaChuZXdTcXVhcmUpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHRoaXMuZ2FtZUJvYXJkID0gbmV3R2FtZUJvYXJkO1xuICB9XG5cbiAgaXNHYW1lT3ZlcigpOiBib29sZWFuIHtcbiAgICBsZXQgbW92ZXM6IFNxdWFyZVtdID0gdGhpcy5fZ2FtZUJvYXJkLnNxdWFyZXMuZmlsdGVyKGZ1bmN0aW9uIChzcXVhcmU6IFNxdWFyZSkge1xuICAgICAgcmV0dXJuIHNxdWFyZS52YWx1ZSA9PT0gc3F1YXJlLmV4cGVjdGVkVmFsdWU7XG4gICAgfSk7XG4gICAgcmV0dXJuIG1vdmVzICYmIG1vdmVzLmxlbmd0aCA9PT0gdGhpcy5fZ2FtZUJvYXJkLnNxdWFyZXMubGVuZ3RoID8gdHJ1ZSA6IGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVFcnJvcnMoZXJyb3I6IGFueSk6IGFueSB7XG4gICAgaWYgKENvbmZpZy5pc0Rldikge1xuICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xuICAgIH1cbiAgICByZXR1cm4gT2JzZXJ2YWJsZS50aHJvdyhlcnJvcik7XG4gIH1cblxuICBwcml2YXRlIHByaW50U3F1YXJlKGk6IG51bWJlciwgc3F1YXJlOiBTcXVhcmUpOiB2b2lkIHtcbiAgICBpZiAoQ29uZmlnLmlzRGV2KSB7XG4gICAgICBjb25zb2xlLmxvZygnU3F1YXJlJyArIChpICsgMSkgKyAnID0geyBpZDogJyArIHNxdWFyZS5pZCArICcsIHJvdzogJyArIHNxdWFyZS5yb3cgKyAnLCBjb2w6ICcgKyBzcXVhcmUuY29sICsgJywgdmFsdWU6ICcgKyBzcXVhcmUudmFsdWUgKyAnLCAnICsgc3F1YXJlLmV4cGVjdGVkVmFsdWUgKyAnLCBjbGFzczogJyArIHNxdWFyZS5jc3NDbGFzcyArICcgfScpO1xuICAgIH1cbiAgfVxufVxuIl19